<!doctype html>
<html>
<head>
<!-- use jQuery 1.X, which supports old browsers too -->
<script src="/jquery-1.11.2.min.js"></script>

<script>window._cors = false;</script>
<!--[if lte IE 9]>
<script>window._cors = false</script>
<![endif]-->

<script>
  window.loaded = {};

  function done(name) {
    // console.log("Done: " + name);
    loaded[name] = true;
    $(".test." + name).addClass("success");
  }

  // inferred to have failed
  function failed(name) {
    // console.log("Failed: " + name);
    $(".test." + name).addClass("failure");
  }
</script>

<style>
  .test {
    background-color: #ddd;
    width: 100%;
    padding: 20px 10px;
    margin: 20px 0;
  }
  .test::before {content: "TESTING."; text-transform: uppercase; padding-right: 10px; font-weight: normal;}
  .test.success::before {content: "PASSED."; font-weight: bold;}
  .test.failure::before {content: "FAILED."; font-weight: bold;}
  .test.success {background-color: #0c0;}
  .test.failure {background-color: #c00;}
</style>

</head>
<body>

<h3>
  This page must be hosted on an insecure (http://) connection to properly test the redirect, otherwise the tests will be interfered with by mixed-content blocking.
</h3>

<ul>
  <li>wzrd.in and wzrd.konklone.io point to the same server.</li>
  <li>wzrd.in redirects HTTP to HTTPS.</li>
  <li>wzrd.konklone.io serves only HTTP.</li>
</ul>

<div class="test script_control_https">
  <strong>Control:</strong> &lt;script&gt; tag for HTTPS asset:
  <code>
    <a href="https://cdn.konklone.io/script_control_https.js">
      https://cdn.konklone.io/script_control_https.js
    </a>
  </code>
</div>

<div class="test script_control_http">
  <strong>Control:</strong> &lt;script&gt; tag for HTTP asset.
  <code>
    <a href="http://plain-cdn.konklone.io/script_control_http.js">
      http://plain-cdn.konklone.io/script_control_http.js
    </a>
  </code>
</div>

<div class="test script_redirect">
  <strong>Test:</strong> &lt;script&gt; tag for HTTP->HTTPS asset redirect.
  <code>
    <a href="https://cdn.konklone.io/script_control_redirect.js">
      http://wzrd.in/standalone/concat-stream@1.4.7
    </a>
  </code>
</div>

<div class="test cors cors_control_https">
  <strong>Control:</strong> CORS GET request for HTTPS asset.
  <code>
    <a href="https://wzrd.in/standalone/underscore@1.7.0">
      https://wzrd.in/standalone/underscore@1.7.0
    </a>
  </code>
</div>

<div class="test cors cors_control_http">
  <strong>Control:</strong> CORS GET request for HTTP asset.
  <code>
    <a href="http://wzrd.konklone.io/standalone/async@0.9.0">
      http://wzrd.konklone.io/standalone/async@0.9.0
    </a>
  </code>
</div>

<div class="test cors cors_redirect">
  <strong>Test:</strong> CORS GET request for HTTP->HTTPS asset redirect.
  <code>
    <a href="http://wzrd.konklone.io/standalone/qs@2.3.3">
      http://wzrd.konklone.io/standalone/qs@2.3.3
    </a>
  </code>
</div>

<script>

  if (!window._cors) $(".cors").hide();

  // control: <script> loading of .js on HTTPS
  $.getScript("https://cdn.konklone.io/script_control_https.js");

  // control: <script> loading of .js on HTTP
  $.getScript("http://wzrd.konklone.io/standalone/q@1.1.2", function() {
    done('script_control_http');
  });

  // test: <script> loading of .js on HTTP->HTTPS redirect
  $.getScript("http://wzrd.in/standalone/concat-stream@1.4.7", function() {
    done('script_redirect');
  });

  if (window._cors) {
    // control: CORS loading of HTTPS
    var cors_control_https = "https://wzrd.in/standalone/underscore@1.7.0";
    $.get(cors_control_https, function() {
      done('cors_control_https');
    }).fail(function() {
      failed('cors_control_https');
    });

    // control: CORS loading of HTTP
    var cors_control_http = "http://wzrd.konklone.io/standalone/async@0.9.0";
    $.get(cors_control_http, function() {
      done('cors_control_http');
    }).fail(function() {
      failed('cors_control_http');
    });

    // test: CORS on HTTP->HTTPS redirect
    var cors_redirect = "http://wzrd.in/standalone/qs@2.3.3";
    $.get(cors_redirect, function() {
      done('cors_redirect');
    }).fail(function() {
      failed('cors_redirect');
    });
  }

  // after 10s, if the <script> tags aren't done, deem them failures
  setTimeout(function() {
    var names = [
      'script_control_https', 'script_control_http', 'script_redirect',
      'cors_control_https',   'cors_control_http',   'cors_redirect'
    ];
    for (var i=0; i<names.length; i++)
      if (!loaded[names[i]]) failed(names[i]);
  }, 10 * 1000)
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-252618-16', 'konklone.io');
  ga('set', 'forceSSL', true);
  ga('set', 'anonymizeIp', true);
  ga('send', 'pageview');
</script>

</body>
</html>
